# CAP 理论

通常情况下，一开始业务需求比较简单直观，用户量不大，采用单机或少量集群即可完成对业务的技术支撑，而随着业务系统不断复杂以及用户规模不断状态，对性要求也会随之增大，单纯提升单机性能从长远来看肯定是不现实的，只有不断横向拓展集群规模，加强对于系统服务的解耦管理，才能有效应对业务复杂度与系统吞吐量的增加。而对于集群管理之下的分布式系统而来，势必会带来CAP理论问题。

## CAP基本内容

对CAP理论的解释：

|-|-|
|---|---|
|Consistency|数据操作完成后，系统各节点的状态保持一致|
|Availability|服务可用，响应时间正常|
|Partition Tolerance|网络隔离导致的分区故障容错保障|

![](http://robertgreiner.com/uploads/images/2014/CAP-overview.png)


通常情况下，CAP三项无法同时保障，仅能实现其中两项，即CP或者AP

对于P条件而言，分布式系统一定会出现网络分区状态，不能够对分区容错进行有效保障的话，分布式系统是没有存在的价值的。

在不能保障P，即当分区容错不能保证的情况下，是不具备保障CA的条件

![](http://www.hollischuang.com/wp-content/uploads/2015/12/Teorema-CAP-2.png)

## CP条件保障：

当分布式系统能够实现对CP条件保障，而牺牲A时，即系统的可用性无法得到有效保障。

即：当系统出现分区故障时，节点间无法取得联系，而部分节点收到处理请求，未免处理过程导致节点同失联节点之间的数据不一致，放弃对请求的处理。

![](http://robertgreiner.com/uploads/images/2014/CAP-CP.png)

缺点：

* 响应时间无法得到保证，可能出现超时
* 或者系统直接返回异常

优点：

* 系统的数据一致性能够得到有效保障，通常是强一致性

这类场景通常是对于数据一致性要求强于系统可用性的场景之下，如交易等

## AP条件保障：

当分布式系统能够实现对AP条件保障，而选择牺牲C时，即系统的一致性（通常是强一致性）不能得到有效保障，而选择实现数据的最终一致性

即： 当出现网络分区状态时候，节点之间无法取得联系，节点接收到处理请求后根据自身的数据进行处理，导致节点之间的数据存在不一致的状态，而当分区恢复之后，系统最终能够回到数据一致的状态。

![](http://robertgreiner.com/uploads/images/2014/CAP-AP.png)

缺点：

* 系统不同节点数据在分区恢复之前存在不一致的状态

优点：

* 系统的可用性能够得到有效保障，不会出现无法服务的异常状态

典型场景如网上购物，系统异常情况下，依然能够下单成功，之后可能通知库存不足而失败，这种方式一定程度上牺牲了数据一致性，影响用户体验，但是能够保证系统的可用性。

## 总结

由于CAP理论的无法兼顾特性，实际系统设计过程中，只能根据系统对于可用性与数据一致性的要求，而选择对CP或者AP的保证度。通常情况下，涉及到交易业务的系统一般在数据一致性上要求高，数据强一致性，这种情况下宁可牺牲可用性，即出现故障时直接停止服务。而对于其他场景，选择保证AP而放弃数据强一致性比较普通，对而求其次，采用数据最终一致性替代。


参考：

[分布式系统CAP理论](http://www.hollischuang.com/archives/666)

[CAP Theorem: Revisited](http://robertgreiner.com/2014/08/cap-theorem-revisited/)